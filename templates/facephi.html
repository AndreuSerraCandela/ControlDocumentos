<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Facephi Completo - Control de Documentos</title>
    <link rel="stylesheet" href="/static/styles.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .back-button {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .back-button:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }
        
        .system-info {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .system-info h3 {
            color: white;
            margin-top: 0;
        }
        
        .system-info p {
            color: rgba(255,255,255,0.9);
            margin: 5px 0;
        }
        
        .react-container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            min-height: 600px;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Animaci√≥n para el spinner de carga */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            background: #ffebee;
            border: 1px solid #f44336;
            color: #c62828;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin: 20px 0;
        }
        
        .credentials-info {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .credentials-info h4 {
            color: white;
            margin-top: 0;
            font-size: 0.9rem;
        }
        
        .credentials-info p {
            color: rgba(255,255,255,0.8);
            font-size: 0.8rem;
            margin: 2px 0;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <a href="/" class="back-button">‚Üê Volver al inicio</a>
    
    <div class="container">
        <div class="header">
            <h1>üîê Sistema Facephi Completo</h1>
            <p>Integraci√≥n completa de frontend y backend Facephi SDK</p>
        </div>
        
        <div class="system-info">
            <h3>üìã Informaci√≥n del Sistema</h3>
            <p><strong>Frontend:</strong> documentos.malla.es</p>
            <p><strong>Backend:</strong> api.identity-platform.io</p>
            <p><strong>Estado:</strong> <span id="system-status">Inicializando...</span></p>
            
            <div class="credentials-info">
                <h4>üîë Credenciales Configuradas</h4>
                <p><strong>Frontend API Key:</strong> 4WpTfNAjrN7O0DSIas53zOfY26QF61rsnA67rUnS</p>
                <p><strong>Backend API Key:</strong> kpl4u8fgxZSqD7LUQva5Myr0G7ab95a8MVO9rBlU</p>
                <p><strong>Artifactory Users:</strong> maybecloudes01, maybecloudes02</p>
                <p><strong>SDK Registry:</strong> facephicorp.jfrog.io/artifactory/api/npm/sdk-web-fphi/</p>
                <p><strong>Nota:</strong> Para usar el SDK real, ejecuta: <code>npm install @facephi/sdk-web-fphi</code></p>
            </div>
        </div>
        
        <div class="react-container">
            <div id="facephi-root">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>Cargando sistema Facephi completo...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- React y dependencias -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- CSS-in-JS simple sin styled-components -->
    
    <!-- Script del componente Facephi -->
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // Configuraci√≥n de Facephi SDK WebComponents
        const facephiConfig = {
            apiKey: '4WpTfNAjrN7O0DSIas53zOfY26QF61rsnA67rUnS',
            baseUrl: 'https://documentos.malla.es',
            backend: {
                apiKey: 'kpl4u8fgxZSqD7LUQva5Myr0G7ab95a8MVO9rBlU',
                baseUrl: 'https://api.identity-platform.io',
                clientId: '52f5e18b-e599-4de3-91e1-f4b0e80ff657',
                secretId: '82880bda-d8c4-448c-baf1-ecc650a3bc58'
            }
        };

        // Funci√≥n para inicializar el SDK de Facephi
        const initializeFacephiSDK = async () => {
            try {
                // Simular verificaci√≥n del SDK (en producci√≥n se cargar√≠a desde npm)
                console.log('Verificando disponibilidad del SDK Facephi...');
                
                // En un entorno real, aqu√≠ verificar√≠as si el SDK est√° instalado
                // Por ahora, siempre retornamos false para usar modo simulado
                const sdkAvailable = false;
                
                if (sdkAvailable) {
                    console.log('Facephi SDK WebComponents cargado correctamente');
                    return true;
                } else {
                    console.log('Facephi SDK WebComponents no disponible, usando modo simulado');
                    console.log('Para usar el SDK real, instala: npm install @facephi/sdk-web-fphi');
                    return false;
                }
            } catch (error) {
                console.error('Error al inicializar Facephi SDK:', error);
                return false;
            }
        };

        // Componentes React simples con CSS inline
        const SystemContainer = ({ children }) => React.createElement('div', {
            style: {
                display: 'flex',
                flexDirection: 'column',
                alignItems: 'center',
                gap: '30px',
                padding: '20px',
                maxWidth: '1200px',
                margin: '0 auto'
            }
        }, children);

        const StatusCard = ({ status, children }) => {
            const getStatusStyles = (status) => {
                switch (status) {
                    case 'success':
                        return {
                            background: '#d4edda',
                            border: '1px solid #c3e6cb',
                            color: '#155724'
                        };
                    case 'error':
                        return {
                            background: '#f8d7da',
                            border: '1px solid #f5c6cb',
                            color: '#721c24'
                        };
                    default:
                        return {
                            background: '#d1ecf1',
                            border: '1px solid #bee5eb',
                            color: '#0c5460'
                        };
                }
            };

            return React.createElement('div', {
                style: {
                    ...getStatusStyles(status),
                    padding: '15px',
                    borderRadius: '10px',
                    margin: '20px 0',
                    textAlign: 'center'
                }
            }, children);
        };

        const ScannerSection = ({ children }) => React.createElement('div', {
            style: {
                width: '100%',
                maxWidth: '600px',
                background: '#fff',
                borderRadius: '15px',
                padding: '30px',
                boxShadow: '0 10px 30px rgba(0,0,0,0.1)'
            }
        }, children);

        const ScannerButton = ({ onClick, disabled, children, style = {} }) => React.createElement('button', {
            onClick,
            disabled,
            style: {
                background: 'linear-gradient(45deg, #667eea, #764ba2)',
                color: 'white',
                border: 'none',
                padding: '20px 40px',
                fontSize: '1.2rem',
                fontWeight: '600',
                borderRadius: '50px',
                cursor: disabled ? 'not-allowed' : 'pointer',
                boxShadow: '0 10px 30px rgba(102, 126, 234, 0.3)',
                transition: 'all 0.3s ease',
                display: 'flex',
                alignItems: 'center',
                gap: '10px',
                margin: '10px auto',
                width: '100%',
                justifyContent: 'center',
                opacity: disabled ? 0.6 : 1,
                ...style
            }
        }, children);

        const VideoContainer = ({ children }) => React.createElement('div', {
            style: {
                width: '100%',
                maxWidth: '500px',
                borderRadius: '20px',
                overflow: 'hidden',
                boxShadow: '0 10px 30px rgba(0,0,0,0.2)',
                background: '#000',
                margin: '20px auto'
            }
        }, children);

        const Video = ({ ref, ...props }) => React.createElement('video', {
            ref,
            style: {
                width: '100%',
                height: 'auto',
                display: 'block'
            },
            ...props
        });

        const ResultsSection = ({ children }) => React.createElement('div', {
            style: {
                width: '100%',
                maxWidth: '800px',
                background: '#fff',
                borderRadius: '15px',
                padding: '30px',
                boxShadow: '0 10px 30px rgba(0,0,0,0.1)',
                marginTop: '30px'
            }
        }, children);

        const ResultsGrid = ({ children }) => React.createElement('div', {
            style: {
                display: 'grid',
                gridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))',
                gap: '20px',
                marginTop: '20px'
            }
        }, children);

        const ResultCard = ({ children }) => React.createElement('div', {
            style: {
                background: '#f8f9fa',
                border: '1px solid #dee2e6',
                borderRadius: '10px',
                padding: '15px'
            }
        }, children);

        const ResultLabel = ({ children }) => React.createElement('div', {
            style: {
                fontWeight: 'bold',
                color: '#495057',
                marginBottom: '5px'
            }
        }, children);

        const ResultValue = ({ children }) => React.createElement('div', {
            style: {
                color: '#6c757d',
                wordBreak: 'break-all'
            }
        }, children);

        const LoadingSpinner = () => React.createElement('div', {
            style: {
                width: '20px',
                height: '20px',
                border: '2px solid #ffffff',
                borderTop: '2px solid transparent',
                borderRadius: '50%',
                animation: 'spin 1s linear infinite'
            }
        });

        function FacephiCompleteSystem() {
            const [isScanning, setIsScanning] = useState(false);
            const [stream, setStream] = useState(null);
            const [scanResults, setScanResults] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [systemStatus, setSystemStatus] = useState('initializing');
            
            const videoRef = useRef(null);
            const canvasRef = useRef(null);

            useEffect(() => {
                initializeSDK();
                
                return () => {
                    if (stream) {
                        stream.getTracks().forEach(track => track.stop());
                    }
                };
            }, []);

            const initializeSDK = async () => {
                try {
                    setSystemStatus('initializing');
                    
                    // Intentar inicializar el SDK real de Facephi
                    const sdkAvailable = await initializeFacephiSDK();
                    
                    if (sdkAvailable) {
                        setSystemStatus('ready');
                        document.getElementById('system-status').textContent = 'Sistema Facephi SDK listo';
                        console.log('SDK de Facephi inicializado correctamente');
                    } else {
                        setSystemStatus('ready');
                        document.getElementById('system-status').textContent = 'Sistema simulado listo';
                        console.log('Usando modo simulado - SDK no disponible');
                    }
                    
                } catch (error) {
                    console.error('Error al inicializar SDK de Facephi:', error);
                    setSystemStatus('error');
                    setError('Error al conectar con los servicios de Facephi');
                    document.getElementById('system-status').textContent = 'Error de conexi√≥n';
                }
            };

            const startScanning = async () => {
                try {
                    setIsScanning(true);
                    setError(null);
                    
                    const mediaStream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            facingMode: 'environment',
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        }
                    });
                    
                    setStream(mediaStream);
                    
                    if (videoRef.current) {
                        videoRef.current.srcObject = mediaStream;
                    }
                    
                } catch (error) {
                    console.error('Error al acceder a la c√°mara:', error);
                    setError('No se pudo acceder a la c√°mara. Por favor, permite el acceso a la c√°mara y recarga la p√°gina.');
                    setIsScanning(false);
                }
            };

            const stopScanning = () => {
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                    setStream(null);
                }
                setIsScanning(false);
            };

            const captureDocument = async () => {
                if (!videoRef.current || !canvasRef.current) return;

                setLoading(true);
                
                try {
                    const video = videoRef.current;
                    const canvas = canvasRef.current;
                    const ctx = canvas.getContext('2d');

                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    
                    const imageData = canvas.toDataURL('image/jpeg', 0.8);
                    
                    // Simular procesamiento con Facephi
                    const documentData = await processDocumentWithFacephi(imageData);
                    
                    setScanResults(documentData);
                    stopScanning();
                    
                } catch (error) {
                    console.error('Error al procesar documento:', error);
                    setError('Error al procesar el documento. Int√©ntalo de nuevo.');
                } finally {
                    setLoading(false);
                }
            };

            const processDocumentWithFacephi = async (imageData) => {
                // Simular procesamiento
                await new Promise(resolve => setTimeout(resolve, 3000));
                
                return {
                    transactionId: generateTransactionId(),
                    frontendResults: {
                        extractedData: {
                            documentNumber: "BOE191477",
                            personalNumber: "10873694F",
                            name: "INES ALVAREZ ALVAREZ",
                            birthDate: "11/11/1970",
                            expiryDate: "17/03/2031",
                            nationality: "ESP"
                        },
                        confidence: 0.95,
                        processingTime: "2.3s"
                    },
                    backendResults: {
                        validation: {
                            isValid: true,
                            checks: {
                                documentAuthenticity: true,
                                dataConsistency: true,
                                expirationDate: true,
                                personalNumber: true
                            },
                            riskScore: 0.1
                        }
                    },
                    timestamp: new Date().toISOString(),
                    systemVersion: 'Facephi Complete v1.0 (Demo)',
                    note: 'Datos de demostraci√≥n - Sistema simulado'
                };
            };

            const generateTransactionId = () => {
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                    const r = Math.random() * 16 | 0;
                    const v = c === 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            };

            const getStatusMessage = () => {
                switch (systemStatus) {
                    case 'initializing':
                        return 'Inicializando sistema Facephi completo...';
                    case 'ready':
                        return 'Sistema Facephi completo listo para usar';
                    case 'error':
                        return 'Error de conexi√≥n con servicios Facephi';
                    default:
                        return 'Estado desconocido';
                }
            };

            const getStatusType = () => {
                switch (systemStatus) {
                    case 'ready':
                        return 'success';
                    case 'error':
                        return 'error';
                    default:
                        return 'info';
                }
            };

            return React.createElement(SystemContainer, null,
                React.createElement(StatusCard, { status: getStatusType() }, getStatusMessage()),
                
                error && React.createElement(StatusCard, { status: "error" }, error),
                
                React.createElement(ScannerSection, null,
                    React.createElement('h3', null, 'üì∑ Captura de Documento'),
                    
                    !isScanning ? 
                        React.createElement(ScannerButton, { 
                            onClick: startScanning, 
                            disabled: systemStatus !== 'ready' 
                        }, 
                            systemStatus !== 'ready' ? React.createElement(LoadingSpinner) : 'üì∑', 
                            ' Iniciar Captura'
                        ) :
                        React.createElement(React.Fragment, null,
                            React.createElement(VideoContainer, null,
                                React.createElement(Video, {
                                    ref: videoRef,
                                    autoPlay: true,
                                    playsInline: true,
                                    muted: true
                                })
                            ),
                            
                            React.createElement(ScannerButton, { 
                                onClick: captureDocument, 
                                disabled: loading 
                            }, 
                                loading ? React.createElement(LoadingSpinner) : 'üì∏', 
                                ' Capturar y Procesar'
                            ),
                            
                            React.createElement(ScannerButton, { 
                                onClick: stopScanning, 
                                style: { background: '#dc3545' } 
                            }, '‚ùå Cancelar')
                        )
                ),

                scanResults && React.createElement(ResultsSection, null,
                    React.createElement('h3', { style: { textAlign: 'center', marginBottom: '20px' } }, 'üìã Resultados del Procesamiento'),
                    
                    React.createElement(ResultsGrid, null,
                        React.createElement(ResultCard, null,
                            React.createElement(ResultLabel, null, 'ID de Transacci√≥n'),
                            React.createElement(ResultValue, null, scanResults.transactionId)
                        ),
                        
                        React.createElement(ResultCard, null,
                            React.createElement(ResultLabel, null, 'N√∫mero de Documento'),
                            React.createElement(ResultValue, null, scanResults.frontendResults.extractedData.documentNumber)
                        ),
                        
                        React.createElement(ResultCard, null,
                            React.createElement(ResultLabel, null, 'N√∫mero Personal'),
                            React.createElement(ResultValue, null, scanResults.frontendResults.extractedData.personalNumber)
                        ),
                        
                        React.createElement(ResultCard, null,
                            React.createElement(ResultLabel, null, 'Nombre Completo'),
                            React.createElement(ResultValue, null, scanResults.frontendResults.extractedData.name)
                        ),
                        
                        React.createElement(ResultCard, null,
                            React.createElement(ResultLabel, null, 'Fecha de Nacimiento'),
                            React.createElement(ResultValue, null, scanResults.frontendResults.extractedData.birthDate)
                        ),
                        
                        React.createElement(ResultCard, null,
                            React.createElement(ResultLabel, null, 'Fecha de Expiraci√≥n'),
                            React.createElement(ResultValue, null, scanResults.frontendResults.extractedData.expiryDate)
                        ),
                        
                        React.createElement(ResultCard, null,
                            React.createElement(ResultLabel, null, 'Nacionalidad'),
                            React.createElement(ResultValue, null, scanResults.frontendResults.extractedData.nationality)
                        ),
                        
                        React.createElement(ResultCard, null,
                            React.createElement(ResultLabel, null, 'Confianza del Procesamiento'),
                            React.createElement(ResultValue, null, (scanResults.frontendResults.confidence * 100).toFixed(1) + '%')
                        ),
                        
                        React.createElement(ResultCard, null,
                            React.createElement(ResultLabel, null, 'Documento V√°lido'),
                            React.createElement(ResultValue, null, scanResults.backendResults.validation.isValid ? '‚úÖ S√≠' : '‚ùå No')
                        ),
                        
                        React.createElement(ResultCard, null,
                            React.createElement(ResultLabel, null, 'Puntuaci√≥n de Riesgo'),
                            React.createElement(ResultValue, null, (scanResults.backendResults.validation.riskScore * 100).toFixed(1) + '%')
                        ),
                        
                        React.createElement(ResultCard, null,
                            React.createElement(ResultLabel, null, 'Tiempo de Procesamiento'),
                            React.createElement(ResultValue, null, scanResults.frontendResults.processingTime)
                        ),
                        
                        React.createElement(ResultCard, null,
                            React.createElement(ResultLabel, null, 'Versi√≥n del Sistema'),
                            React.createElement(ResultValue, null, scanResults.systemVersion)
                        )
                    ),
                    
                    scanResults.note && React.createElement(StatusCard, { 
                        status: "info", 
                        style: { marginTop: '20px' } 
                    }, '‚ÑπÔ∏è ' + scanResults.note)
                ),

                React.createElement('canvas', {
                    ref: canvasRef,
                    style: { display: 'none' }
                })
            );
        }

        // Renderizar el componente
        ReactDOM.render(React.createElement(FacephiCompleteSystem), document.getElementById('facephi-root'));
    </script>
</body>
</html>
