<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document Scanner - Sistema de Documentos</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            text-align: center;
            padding: 40px 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .tab {
            flex: 1;
            padding: 20px;
            border: none;
            background: transparent;
            color: #6c757d;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            background: white;
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .tab-content {
            padding: 40px;
            min-height: 600px;
        }

        .scanner-container {
            text-align: center;
        }

        .scanner-button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 20px 40px;
            font-size: 1.2rem;
            font-weight: 600;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
            margin: 20px;
        }

        .scanner-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.4);
        }

        .scanner-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .video-container {
            width: 100%;
            max-width: 500px;
            margin: 20px auto;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            background: #000;
        }

        .video {
            width: 100%;
            height: auto;
            display: block;
        }

        .instructions {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }

        .instructions h3 {
            color: #1976d2;
            margin-bottom: 10px;
        }

        .instructions ul {
            color: #1976d2;
            text-align: left;
            margin: 0;
            padding-left: 20px;
        }

        .message {
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }

        .message.error {
            background: #ffebee;
            border: 1px solid #f44336;
            color: #c62828;
        }

        .message.success {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            color: #2e7d32;
        }

        .documents-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .document-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }

        .document-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        .document-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .document-title {
            margin: 0;
            color: #333;
            font-size: 1.2rem;
        }

        .document-status {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .status-valid {
            background: #d4edda;
            color: #155724;
        }

        .status-invalid {
            background: #f8d7da;
            color: #721c24;
        }

        .document-info {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .info-label {
            font-weight: 600;
            color: #666;
        }

        .info-value {
            color: #333;
            text-align: right;
            word-break: break-word;
        }

        .stats-container {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .stats-title {
            margin: 0 0 10px 0;
            font-size: 1.5rem;
        }

        .stats-number {
            font-size: 2rem;
            font-weight: bold;
            margin: 10px 0;
        }

        .search-container {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .search-form {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .search-input {
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1rem;
            flex: 1;
            min-width: 200px;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .search-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .search-button:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
        }

        .refresh-button {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .refresh-button:hover {
            background: #218838;
            transform: translateY(-1px);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 1.1rem;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì± Document Scanner</h1>
            <p>Sistema de escaneo de documentos con tecnolog√≠a Facephi</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('scanner')">üì± Escanear Documento</button>
            <button class="tab" onclick="showTab('results')">üìã Documentos Escaneados</button>
        </div>

        <div class="tab-content">
            <!-- Scanner Tab -->
            <div id="scanner-tab" class="scanner-container">
                <div class="instructions">
                    <h3>üìã Instrucciones para escanear</h3>
                    <ul>
                        <li>Aseg√∫rate de tener buena iluminaci√≥n</li>
                        <li>Coloca el documento sobre una superficie plana</li>
                        <li>Mant√©n la c√°mara estable y perpendicular al documento</li>
                        <li>El documento debe ocupar la mayor parte del marco</li>
                    </ul>
                </div>

                <div id="error-message" class="message error hidden"></div>
                <div id="success-message" class="message success hidden"></div>

                <button id="start-scan-btn" class="scanner-button" onclick="startScanning()">
                    üì∑ Iniciar Escaneo
                </button>

                <div id="video-container" class="video-container hidden">
                    <video id="video" class="video" autoplay playsinline muted></video>
                </div>

                <div id="capture-buttons" class="hidden">
                    <button id="capture-btn" class="scanner-button" onclick="captureDocument()">
                        üì∏ Capturar Parte Delantera
                    </button>
                    <button class="scanner-button" onclick="stopScanning()" style="background: #dc3545;">
                        ‚ùå Cancelar
                    </button>
                </div>
            </div>

            <!-- Results Tab -->
            <div id="results-tab" class="hidden">
                <div class="stats-container">
                    <h2 class="stats-title">üìä Estad√≠sticas</h2>
                    <div class="stats-number" id="documents-count">0</div>
                    <div>Documentos escaneados</div>
                </div>

                <div class="search-container">
                    <form class="search-form" onsubmit="searchDocuments(event)">
                        <input type="text" id="nationality-search" class="search-input" placeholder="C√≥digo de nacionalidad (ej: ESP)">
                        <input type="text" id="dni-search" class="search-input" placeholder="DNI">
                        <button type="submit" class="search-button">üîç Buscar</button>
                        <button type="button" class="refresh-button" onclick="loadDocuments()">üîÑ Actualizar</button>
                    </form>
                </div>

                <div id="documents-container">
                    <div class="loading">üîÑ Cargando documentos...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8001';
        let currentStream = null;
        let documents = [];
        let captureStep = 'front'; // 'front' o 'back'
        let frontImageData = null;

        // Tab management
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('[id$="-tab"]').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + '-tab').classList.remove('hidden');
            
            // Add active class to clicked tab button
            event.target.classList.add('active');
            
            // Load documents if results tab
            if (tabName === 'results') {
                loadDocuments();
            }
        }

        // Scanner functions
        async function startScanning() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                });
                
                currentStream = stream;
                document.getElementById('video').srcObject = stream;
                document.getElementById('video-container').classList.remove('hidden');
                document.getElementById('capture-buttons').classList.remove('hidden');
                document.getElementById('start-scan-btn').classList.add('hidden');
                
            } catch (error) {
                showError('No se pudo acceder a la c√°mara. Por favor, permite el acceso a la c√°mara y recarga la p√°gina.');
            }
        }

        function stopScanning() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
            
            document.getElementById('video-container').classList.add('hidden');
            document.getElementById('capture-buttons').classList.add('hidden');
            document.getElementById('start-scan-btn').classList.remove('hidden');
        }

        async function captureDocument() {
            const video = document.getElementById('video');
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            const imageData = canvas.toDataURL('image/jpeg', 0.8);
            
            //if (captureStep === 'front') {
                // Capturar parte delantera
                frontImageData = imageData;
                //captureStep = 'back';
                
                // Mostrar instrucciones para la parte trasera
                //showMessage('‚úÖ Parte delantera capturada. Ahora da la vuelta al documento y captura la parte trasera', 'info');
                
                // Actualizar el bot√≥n de captura
                //const captureBtn = document.getElementById('capture-btn');
                //captureBtn.textContent = 'Capturar Parte Trasera';
                //captureBtn.style.backgroundColor = '#ff9800';
                
                // Continuar con la c√°mara activa para la siguiente captura
                
            //} else if (captureStep === 'back') {
                // Capturar parte trasera y procesar ambas im√°genes
            const backImageData = imageData;
            
            // Procesar ambas im√°genes con Facephi
            const documentData = await processDocumentWithFacephi(frontImageData, null);
            
            // Send to backend
            await sendDocumentToBackend(documentData);
            
            // Add to local documents list
            documents.push(documentData);
            updateDocumentsList();
            
            // Reset para la siguiente captura
            resetCaptureFlow();
            stopScanning();
            
            // Show success message
            showSuccess('Documento completo capturado y procesado correctamente');
            //}
        }

        async function processDocumentWithFacephi(frontImageData, backImageData) {
            console.log('üîç DEBUG: Iniciando procesamiento de documento');
            console.log('üîç DEBUG: Imagen delantera, tama√±o:', frontImageData.length, 'caracteres');
            console.log('üîç DEBUG: Imagen trasera, tama√±o:', backImageData ? backImageData.length : 'null', 'caracteres');
            
            try {
                showMessage('üîÑ Procesando documento con Facephi SDK...', 'info');
                
                // Configuraci√≥n de Facephi
                const facephiConfig = {
                    apiKey: 'kpl4u8fgxZSqD7LUQva5Myr0G7ab95a8MVO9rBlU',
                    baseUrl: 'https://api.identity-platform.io'
                };

                console.log('üîç DEBUG: Configuraci√≥n Facephi:', {
                    apiKey: facephiConfig.apiKey.substring(0, 10) + '...',
                    baseUrl: facephiConfig.baseUrl
                });

                // PASO 1: Llamar a documentValidation/v2/start para obtener scanReference
                console.log('üîç DEBUG: PASO 1 - Llamando a documentValidation/v2/start...');
                
                // Convertir imagen delantera a base64
                const frontResponse = await fetch(frontImageData);
                const frontBlob = await frontResponse.blob();
                const frontBase64 = await new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.readAsDataURL(frontBlob);
                });
                
                // Convertir imagen trasera a base64
                //Si no hay imagen trasera, se env√≠a null
                let backBase64 = null;
                if (backImageData) {
                    const backResponse = await fetch(backImageData);
                    const backBlob = await backResponse.blob();
                    backBase64 = await new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result.split(',')[1]);
                        reader.readAsDataURL(backBlob);
                    });
                }
                
                console.log('üîç DEBUG: Imagen delantera convertida, tama√±o:', frontBase64.length, 'caracteres');
                console.log('üîç DEBUG: Imagen trasera convertida, tama√±o:', backBase64 ? backBase64.length : 'null', 'caracteres');
                
                const startData = {
                    country: "ESP",
                    idType: "ID_CARD",
                    documentRawImageMimeType: "image/jpeg",
                    documentFrontRawImage: frontBase64,
                    ...(backBase64 ? { documentBackRawImage: backBase64 } : {}),
                    merchantIdScanReference: `scan_ref_${Date.now()}`
                };
                
                console.log('üîç DEBUG: Datos de start:', {
                    country: startData.country,
                    idType: startData.idType,
                    mimeType: startData.documentRawImageMimeType,
                    scanReference: startData.merchantIdScanReference,
                    frontImageSize: frontBase64.length,
                    backImageSize: backBase64 ? backBase64.length : null
                });
                
                const startResponse = await fetch(facephiConfig.baseUrl + '/verify/documentValidation/v2/start', {
                    method: 'POST',
                    headers: {
                        'x-api-key': facephiConfig.apiKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(startData)
                });
                
                console.log('üîç DEBUG: Respuesta de start:', {
                    status: startResponse.status,
                    statusText: startResponse.statusText
                });
                
                if (!startResponse.ok) {
                    const errorText = await startResponse.text();
                    console.error('üîç DEBUG: Error en start:', errorText);
                    throw new Error(`Error en documentValidation/start: ${startResponse.status} - ${errorText}`);
                }
                
                const startResult = await startResponse.json();
                console.log('üîç DEBUG: Resultado de start:', startResult);
                
                // Extraer scanReference de la respuesta
                const scanReference = startResult.scanReference;
                if (!scanReference) {
                    throw new Error('No se recibi√≥ scanReference de Facephi');
                }
                
                console.log('üîç DEBUG: ScanReference obtenido:', scanReference);
                
                // PASO 2: Esperar 30 segundos y llamar a /status
                console.log('üîç DEBUG: PASO 2 - Esperando 10 segundos...');
                showMessage('‚è≥ Procesando documento... (10 segundos)', 'info');
                
                await new Promise(resolve => setTimeout(resolve, 10000));
                
                console.log('üîç DEBUG: Llamando a /status con scanReference:', scanReference);
                const startDataref = {
                    "scanReference": scanReference
                }
                const statusResponse = await fetch(facephiConfig.baseUrl + `/verify/documentValidation/v2/status`, {
                    method: 'POST',
                    headers: {
                        'x-api-key': facephiConfig.apiKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(startDataref)
                });
                
                console.log('üîç DEBUG: Respuesta de status:', {
                    status: statusResponse.status,
                    statusText: statusResponse.statusText
                });
                
                if (!statusResponse.ok) {
                    const errorText = await statusResponse.text();
                    console.error('üîç DEBUG: Error en status:', errorText);
                    throw new Error(`Error en documentValidation/status: ${statusResponse.status} - ${errorText}`);
                }
                
                const statusResult = await statusResponse.json();
                console.log('üîç DEBUG: Resultado de status:', statusResult);
                
                // Verificar el status y manejar polling si es PENDING
                if (statusResult.status === 'PENDING') {
                    console.log('üîç DEBUG: Status es PENDING, iniciando polling...');
                    showMessage('‚è≥ Procesando documento... (verificando estado)', 'info');
                    
                    // Polling cada 2 segundos hasta que sea DONE o FAILED
                    let attempts = 0;
                    const maxAttempts = 30; // M√°ximo 60 segundos de polling
                    
                    while (attempts < maxAttempts) {
                        await new Promise(resolve => setTimeout(resolve, 2000)); // Esperar 2 segundos
                        attempts++;
                        
                        console.log(`üîç DEBUG: Polling intento ${attempts}/${maxAttempts}...`);
                        showMessage(`‚è≥ Procesando documento... (intento ${attempts}/${maxAttempts})`, 'info');
                        
                        const pollResponse = await fetch(facephiConfig.baseUrl + `/verify/documentValidation/v2/status`, {
                            method: 'POST',
                            headers: {
                                'x-api-key': facephiConfig.apiKey,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(startDataref)
                        });
                        
                        if (!pollResponse.ok) {
                            throw new Error(`Error en polling de status: ${pollResponse.status}`);
                        }
                        
                        const pollResult = await pollResponse.json();
                        console.log(`üîç DEBUG: Polling resultado ${attempts}:`, pollResult);
                        
                        if (pollResult.status === 'DONE') {
                            console.log('üîç DEBUG: Status cambi√≥ a DONE, llamando a /data...');
                            showMessage('‚úÖ Documento procesado, obteniendo datos...', 'success');
                            
                            const dataResponse = await fetch(facephiConfig.baseUrl + '/verify/documentValidation/v2/data', {
                                method: 'POST',
                                headers: {
                                    'x-api-key': facephiConfig.apiKey,
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    scanReference: scanReference,
                                    type: 'ID_CARD'
                                })
                            });
                            
                            console.log('üîç DEBUG: Respuesta de data:', {
                                status: dataResponse.status,
                                statusText: dataResponse.statusText
                            });
                            
                            if (!dataResponse.ok) {
                                const errorText = await dataResponse.text();
                                console.error('üîç DEBUG: Error en data:', errorText);
                                throw new Error(`Error en documentValidation/data: ${dataResponse.status} - ${errorText}`);
                            }
                            
                            const dataResult = await dataResponse.json();
                            console.log('üîç DEBUG: Resultado de data:', dataResult);
                            
                            // Procesar datos y salir del polling
                            return await processDocumentData(dataResult, scanReference);
                            
                        } else if (pollResult.status === 'FAILED') {
                            console.log('üîç DEBUG: Status cambi√≥ a FAILED');
                            showMessage('‚ùå Error procesando documento. Por favor, vuelve a escanear.', 'error');
                            throw new Error('El procesamiento del documento fall√≥. Por favor, vuelve a escanear.');
                        }
                        // Si sigue siendo PENDING, continuar el polling
                    }
                    
                    // Si llegamos aqu√≠, se agotaron los intentos
                    throw new Error('Tiempo de espera agotado. El documento est√° tardando demasiado en procesarse.');
                    
                } else if (statusResult.status === 'DONE') {
                    console.log('üîç DEBUG: Status es DONE, llamando a /data...');
                    
                    const dataResponse = await fetch(facephiConfig.baseUrl + '/verify/documentValidation/v2/data', {
                        method: 'POST',
                        headers: {
                            'x-api-key': facephiConfig.apiKey,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            scanReference: scanReference,
                            type: 'ID_CARD'
                        })
                    });
                    
                    console.log('üîç DEBUG: Respuesta de data:', {
                        status: dataResponse.status,
                        statusText: dataResponse.statusText
                    });
                    
                    if (!dataResponse.ok) {
                        const errorText = await dataResponse.text();
                        console.error('üîç DEBUG: Error en data:', errorText);
                        throw new Error(`Error en documentValidation/data: ${dataResponse.status} - ${errorText}`);
                    }
                    
                    const dataResult = await dataResponse.json();
                    console.log('üîç DEBUG: Resultado de data:', dataResult);
                    
                    // Procesar datos
                    return await processDocumentData(dataResult, scanReference);
                    
                } else if (statusResult.status === 'FAILED') {
                    console.log('üîç DEBUG: Status es FAILED');
                    showMessage('‚ùå Error procesando documento. Por favor, vuelve a escanear.', 'error');
                    throw new Error('El procesamiento del documento fall√≥. Por favor, vuelve a escanear.');
                } else {
                    throw new Error(`Status desconocido: ${statusResult.status}`);
                }
            } catch (error) {
                console.error('üîç DEBUG: Error completo:', error);
                console.error('üîç DEBUG: Stack trace:', error.stack);
                showMessage('‚ùå Error procesando documento: ' + error.message, 'error');
                
                // Fallback a datos simulados si Facephi falla
                console.log('üîç DEBUG: Usando datos simulados como respaldo');
                showMessage('‚ö†Ô∏è Usando datos de prueba como respaldo', 'warning');
                return getMockDocumentData(frontImageData, backImageData);
            }
            
            // Funci√≥n para procesar los datos del documento
            async function processDocumentData(dataResult, scanReference) {
                // Procesar la respuesta real de Facephi del endpoint /data
                const person = dataResult.verification?.person || {};
                const document = dataResult.verification?.document || {};
                
                // Mapear los datos de Facephi al formato esperado por el backend
                const documentData = {
                    transactionId: generateTransactionId(),
                    dni: person.idNumber || document.number || "REAL_DNI_" + Math.random().toString(36).substr(2, 9),
                    clientData: {
                        customerId: generateCustomerId()
                    },
                    deviceInfo: {
                        osVersion: navigator.userAgent,
                        model: "Web Browser",
                        brand: "Web",
                        browser: navigator.userAgent,
                        osName: navigator.platform
                    },
                    resultJSON: {
                        DocumentData: {
                            serviceTransactionId: dataResult.verification?.scanReference || generateTransactionId(),
                            serviceDocument: {
                                // Estructura esperada por el backend
                                FRONTSIDE: {
                                    FIELD_DATA: {
                                        GIVEN_NAMES: person.firstName || "",
                                        SURNAME: [person.lastName || ""],
                                        NATIONALITY_CODE: document.country || "ESP",
                                        SEX: person.gender || "M",
                                        DATE_OF_BIRTH: person.dateOfBirth || "",
                                        DATE_OF_EXPIRY: document.validUntil || "",
                                        DOCUMENT_NUMBER: document.number || "",
                                        IDENTITY_NUMBER: person.idNumber || document.number || ""
                                    }
                                },
                                BACKSIDE: {
                                    FIELD_DATA: {
                                        ADDRESS: [document.placeOfIssue || ""],
                                        BIRTH_DATE: person.dateOfBirth || "",
                                        EXPIRATION_DATE: document.validUntil || ""
                                    }
                                },
                                CHECKS: {
                                    PERSONAL_NUMBER_SIDE_MATCH: true,
                                    SEX_SIDE_MATCH: true,
                                    FRONTSIDE_EXPIRATION_DATE_VALID: true,
                                    FULLNAME_SIDE_MATCH: true,
                                    NATIONALITY_CODE_SIDE_MATCH: true
                                },
                                // Datos originales de Facephi para referencia
                                FACEPHI_ORIGINAL: dataResult.verification
                            }
                        }
                    }
                };
                
                console.log('üîç DEBUG: Datos del documento procesados desde /data:', documentData);
                showMessage('‚úÖ Documento procesado correctamente con Facephi /data', 'success');
                return documentData;
            }
        }

        function getMockDocumentData(frontImageData, backImageData) {
            return {
                transactionId: generateTransactionId(),
                dni: "10873694F",
                clientData: {
                    customerId: generateCustomerId()
                },
                deviceInfo: {
                    osVersion: navigator.userAgent,
                    model: "Web Browser",
                    brand: "Web",
                    browser: navigator.userAgent,
                    osName: navigator.platform
                },
                resultJSON: {
                    DocumentData: {
                        serviceTransactionId: generateTransactionId(),
                        serviceDocument: {
                            CHECKS: {
                                PERSONAL_NUMBER_SIDE_MATCH: true,
                                SEX_SIDE_MATCH: true,
                                BACKSIDE_AGE_IS_ADULT: true,
                                BACKSIDE_EXPIRATION_DATE_VALID: true,
                                BACKSIDE_PERSONAL_NUMBER_CHECK_DIGIT_VALID: true,
                                DATE_OF_BIRTH_SIDE_MATCH: true,
                                DATE_OF_EXPIRY_SIDE_MATCH: true,
                                FRONTSIDE_AGE_IS_ADULT: true,
                                FRONTSIDE_EXPIRATION_DATE_VALID: true,
                                FRONTSIDE_PERSONAL_NUMBER_CHECK_DIGIT_VALID: true,
                                FULLNAME_SIDE_MATCH: true,
                                MRZ_CHECK_DIGIT_DOB: "1",
                                MRZ_CHECK_DIGIT_DOB_IS_VALID: true,
                                MRZ_CHECK_DIGIT_DOCUMENT_NUMBER: "4",
                                MRZ_CHECK_DIGIT_DOCUMENT_NUMBER_IS_VALID: true,
                                MRZ_CHECK_DIGIT_EXPIRY: "5",
                                MRZ_CHECK_DIGIT_EXPIRY_IS_VALID: true,
                                MRZ_CHECK_DIGIT_FINALCHECK: "1",
                                MRZ_CHECK_DIGIT_FINALCHECK_IS_VALID: true,
                                NATIONALITY_CODE_SIDE_MATCH: true
                            },
                            FRONTSIDE: {
                                FIELD_DATA: {
                                    PERSONAL_NUMBER: "10873694F",
                                    SEX: "F",
                                    SURNAME: ["ALVAREZ", "ALVAREZ"],
                                    CARD_ACCESS_NUMBER: "199616",
                                    DATE_OF_BIRTH: "11/11/1970",
                                    DATE_OF_EXPIRY: "17/03/2031",
                                    DOCUMENT_NUMBER: "BOE191477",
                                    FIRST_SURNAME: "ALVAREZ",
                                    GIVEN_NAMES: "INES",
                                    NATIONALITY_CODE: "ESP",
                                    SECOND_SURNAME: "ALVAREZ"
                                }
                            },
                            BACKSIDE: {
                                FIELD_DATA: {
                                    ADDRESS: ["C. CONCEJO DE CARAVIA 2 P02", "GIJ√ìN", "ASTURIAS"],
                                    AUTHORITY_CODE: "33277L6D2",
                                    E_ID_PLACE_OF_BIRTH_CITY: ["GIJ√ìN", "ASTURIAS"],
                                    PARENTS_GIVEN_NAMES: "ALBERTO SUSANA"
                                },
                                MRZ_DATA: {
                                    BIRTH_DATE: "11/11/1970",
                                    EXPIRATION_DATE: "17/03/2031",
                                    IDENTITY_NUMBER: "80E191477",
                                    ISSUING_COUNTRY: "ESP",
                                    NAME: "INES",
                                    NATIONALITY: "ESP",
                                    PERSONAL_NUMBER: "10873694F",
                                    SEX: "F",
                                    SURNAME: "ALVAREZ ALVAREZ"
                                }
                            },
                            DECOMPOSED: {
                                FACE: imageData
                            }
                        }
                    }
                }
            };
        }

        async function sendDocumentToBackend(documentData) {
            try {
                // Log document data being sent
                console.log('üì§ ENVIANDO DOCUMENTO AL BACKEND:');
                console.log('=====================================');
                console.log('üÜî Transaction ID:', documentData.transactionId);
                console.log('üìã DNI:', documentData.dni);
                console.log('üë§ Nombre:', documentData.resultJSON?.DocumentData?.serviceDocument?.FRONTSIDE?.FIELD_DATA?.GIVEN_NAMES || 'N/A');
                console.log('üè† Nacionalidad:', documentData.resultJSON?.DocumentData?.serviceDocument?.FRONTSIDE?.FIELD_DATA?.NATIONALITY_CODE || 'N/A');
                console.log('üì± Dispositivo:', documentData.deviceInfo?.osName || 'N/A');
                console.log('=====================================');
                
                const response = await fetch(`${API_BASE_URL}/check-document`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(documentData)
                });

                const result = await response.json();
                
                console.log('üì• RESPUESTA DEL BACKEND:', result);
                
                if (result.exists) {
                    showError('Este documento ya existe en la base de datos');
                } else {
                    showSuccess('Documento agregado correctamente');
                }
            } catch (error) {
                console.error('‚ùå ERROR AL ENVIAR DOCUMENTO:', error);
                showError('Error al procesar el documento: ' + error.message);
            }
        }
        
        // Funci√≥n para resetear el flujo de captura
        function resetCaptureFlow() {
            captureStep = 'front';
            frontImageData = null;
            
            // Restaurar bot√≥n
            const captureBtn = document.getElementById('capture-btn');
            captureBtn.textContent = 'Capturar Parte Delantera';
            captureBtn.style.backgroundColor = '#2196F3';
            
            // Mostrar mensaje de listo para el siguiente escaneo
            showMessage('üîÑ Listo para el siguiente escaneo. Haz clic en "Iniciar Escaneo" para comenzar', 'info');
        }

        // Document management functions
        async function loadDocuments() {
            try {
                const response = await fetch(`${API_BASE_URL}/documents`);
                const data = await response.json();
                documents = data.documents;
                displayDocuments();
                updateStats();
            } catch (error) {
                showError('Error al cargar documentos: ' + error.message);
            }
        }

        async function searchDocuments(event) {
            event.preventDefault();
            
            const nationality = document.getElementById('nationality-search').value;
            const dni = document.getElementById('dni-search').value;
            
            try {
                let url = `${API_BASE_URL}/documents/search?`;
                const params = new URLSearchParams();
                if (nationality) params.append('nationality', nationality);
                if (dni) params.append('dni', dni);
                url += params.toString();
                
                const response = await fetch(url);
                const data = await response.json();
                documents = data.documents;
                displayDocuments();
            } catch (error) {
                showError('Error al buscar documentos: ' + error.message);
            }
        }

        function displayDocuments() {
            const container = document.getElementById('documents-container');
            
            if (documents.length === 0) {
                container.innerHTML = '<div class="loading">üìÑ No hay documentos para mostrar</div>';
                return;
            }

            const html = documents.map(doc => {
                const info = extractDocumentInfo(doc);
                return `
                    <div class="document-card">
                        <div class="document-header">
                            <h3 class="document-title">${info.name} ${info.surname}</h3>
                            <span class="document-status ${info.isValid ? 'status-valid' : 'status-invalid'}">
                                ${info.isValid ? '‚úÖ V√°lido' : '‚ùå Inv√°lido'}
                            </span>
                        </div>
                        <div class="document-info">
                            <div class="info-row">
                                <span class="info-label">DNI:</span>
                                <span class="info-value">${info.dni}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Nacionalidad:</span>
                                <span class="info-value">${info.nationality}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">N√∫mero de documento:</span>
                                <span class="info-value">${info.documentNumber}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Fecha de nacimiento:</span>
                                <span class="info-value">${info.birthDate}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Fecha de expiraci√≥n:</span>
                                <span class="info-value">${info.expiryDate}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Sexo:</span>
                                <span class="info-value">${info.sex}</span>
                            </div>
                            ${info.address ? `
                                <div class="info-row">
                                    <span class="info-label">Direcci√≥n:</span>
                                    <span class="info-value">${info.address}</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = `<div class="documents-grid">${html}</div>`;
        }

        function extractDocumentInfo(doc) {
            try {
                const frontside = doc.resultJSON?.DocumentData?.serviceDocument?.FRONTSIDE?.FIELD_DATA;
                const backside = doc.resultJSON?.DocumentData?.serviceDocument?.BACKSIDE?.MRZ_DATA;
                const checks = doc.resultJSON?.DocumentData?.serviceDocument?.CHECKS;
                
                return {
                    dni: doc.dni,
                    name: frontside?.GIVEN_NAMES || backside?.NAME || '',
                    surname: frontside?.SURNAME?.join(' ') || backside?.SURNAME || '',
                    nationality: frontside?.NATIONALITY_CODE || backside?.NATIONALITY || '',
                    documentNumber: frontside?.DOCUMENT_NUMBER || backside?.IDENTITY_NUMBER || '',
                    birthDate: frontside?.DATE_OF_BIRTH || backside?.BIRTH_DATE || '',
                    expiryDate: frontside?.DATE_OF_EXPIRY || backside?.EXPIRATION_DATE || '',
                    sex: frontside?.SEX || backside?.SEX || '',
                    address: backside?.ADDRESS?.join(', ') || '',
                    isValid: checks ? Object.values(checks).every(check => check === true) : false
                };
            } catch (error) {
                return {
                    dni: doc.dni,
                    name: '',
                    surname: '',
                    nationality: '',
                    documentNumber: '',
                    birthDate: '',
                    expiryDate: '',
                    sex: '',
                    address: '',
                    isValid: false
                };
            }
        }

        function updateStats() {
            document.getElementById('documents-count').textContent = documents.length;
        }

        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            document.getElementById('success-message').classList.add('hidden');
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('success-message');
            successDiv.textContent = message;
            successDiv.classList.remove('hidden');
            document.getElementById('error-message').classList.add('hidden');
        }

        function showMessage(message, type = 'info') {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = message;
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: bold;
                z-index: 10000;
                max-width: 300px;
                word-wrap: break-word;
            `;
            
            // Colores seg√∫n el tipo
            switch(type) {
                case 'success':
                    messageDiv.style.backgroundColor = '#28a745';
                    break;
                case 'error':
                    messageDiv.style.backgroundColor = '#dc3545';
                    break;
                case 'warning':
                    messageDiv.style.backgroundColor = '#ffc107';
                    messageDiv.style.color = '#000';
                    break;
                case 'info':
                default:
                    messageDiv.style.backgroundColor = '#17a2b8';
                    break;
            }
            
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.remove();
                }
            }, 5000);
        }

        function generateTransactionId() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function generateCustomerId() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadDocuments();
        });
    </script>
</body>
</html>
